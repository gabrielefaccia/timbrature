
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Timbratura REST vtenext</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      padding: 20px;
      text-align: center;
    }
    .container {
      background: white;
      max-width: 500px;
      margin: 20px auto;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    input, select, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      box-sizing: border-box;
    }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <header>
    <img src="data:image/jpeg;base64,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" alt="Logo" style="max-width: 100%; height: auto; margin-bottom: 10px;">
    <h1 style="font-size: 24px; margin-top: 0;">Timbratore</h1>
  </header>

  <div class="container" id="loginForm">
    
    <input type="text" id="username" placeholder="Nome utente" required>
    <input type="password" id="accessKey" placeholder="Access Key" required>
    <button onclick="verificaAccesso()">Accedi</button>
    <p id="loginMessage" class="error"></p>
  </div>

  <div class="container" id="timbraturaForm" style="display:none;">
    <h3>Timbratura</h3>
    <select id="tipo">
      <option value="Entrata">Entrata</option>
      <option value="Uscita">Uscita</option>
    </select>
    <button onclick="timbra()">Timbra</button>
    <p id="esitoTimbratura" class="success"></p>
    <button onclick="logout()">Logout</button>
  </div>

  <script>
    let basicToken = "";
    let userId = "";

    function verificaAccesso() {
      const username = document.getElementById("username").value;
      const accessKey = document.getElementById("accessKey").value;
      basicToken = btoa(username + ":" + accessKey);
      localStorage.setItem("vte_token", basicToken);

      fetch("https://crm.fefcentroautomazioni.it/restapi/v1/vtews/me", {
        method: "GET",
        headers: {
          "Authorization": "Basic " + basicToken
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success && data.result && data.result.id) {
          userId = data.result.id;
          document.getElementById("loginForm").style.display = "none";
          document.getElementById("timbraturaForm").style.display = "block";
        } else {
          document.getElementById("loginMessage").innerText = "Accesso negato.";
        }
      })
      .catch(err => {
        document.getElementById("loginMessage").innerText = "Errore di rete: " + err;
      });
    }

    function timbra() {
      const tipo = document.getElementById("tipo").value;

      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
        .then(res => res.json())
        .then(data => {
          const indirizzo = data.display_name || "Indirizzo non trovato";
          const now = new Date();
          const dataStr = now.toISOString().split("T")[0];
          const ora = now.toTimeString().split(" ")[0];

          const record = {
            elementType: "Timbrature",
            element: {
              tipo_timbratura: tipo,
              latitudine: lat,
              longitudine: lon,
              indirizzo: indirizzo,
              data: dataStr,
              ora: ora,
              assigned_user_id: userId
            }
          };

          fetch("https://crm.fefcentroautomazioni.it/restapi/v1/vtews/create", {
            method: "POST",
            headers: {
              "Authorization": "Basic " + basicToken,
              "Content-Type": "application/json"
            },
            body: JSON.stringify(record)
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              document.getElementById("esitoTimbratura").innerText = "Timbratura registrata con successo!";
            } else {
              document.getElementById("esitoTimbratura").innerText = "Errore: " + data.error.message;
            }
          });
        });
      }, () => {
        document.getElementById("esitoTimbratura").innerText = "Errore: Geolocalizzazione non disponibile.";
      });
    }

    function logout() {
      basicToken = "";
      userId = "";
      localStorage.removeItem("vte_token");
      document.getElementById("timbraturaForm").style.display = "none";
      document.getElementById("loginForm").style.display = "block";
    }

    window.onload = function() {
      const storedToken = localStorage.getItem("vte_token");
      if (storedToken) {
        basicToken = storedToken;
        fetch("https://crm.fefcentroautomazioni.it/restapi/v1/vtews/me", {
          method: "GET",
          headers: {
            "Authorization": "Basic " + basicToken
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.result && data.result.id) {
            userId = data.result.id;
            document.getElementById("loginForm").style.display = "none";
            document.getElementById("timbraturaForm").style.display = "block";
          } else {
            localStorage.removeItem("vte_token");
          }
        });
      }
    };
  </script>
</body>
</html>
